<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #202020;
      color: #f5f5f5;
    }
    button { padding: 5px 12px; cursor:pointer; }
    button:disabled { background:#666; cursor:default; }

    .log-container { display: flex; gap: 12px; margin-top: 10px;}
    .log-box {
      flex: 1; background:#111; border-radius:6px;
      padding:6px; height:220px; overflow-y: auto;
      font-size: 12px; font-family: Consolas;
    }
    .battle-log{ color:#ffd54f;}
    .skill-log{ color:#81d4fa;}
    .system-log{ color:#a5d6a7;}
    .error-log{ color:#ef9a9a;}
    .debug-log{ color:#b0bec5;}

    #skillPopup{
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center;
    }
    #skillBox{
      background:#2b2b2b; padding:20px; border-radius:10px;
      width:380px;
    }
    .skillRow{ margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid #555;}
    .skillName{ color:#81d4fa; font-size:16px; }
    .skillDesc{ white-space:pre-line; font-size:13px; color:#ddd; }


   
    /* ===== ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¨ä½“ ===== */
    .status-area {
      margin-top: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 12px;
    }

    /* ===== è‡ªåˆ† / ç›¸æ‰‹ å…±é€š ===== */
    .status-simple {
      width: 240px;
      padding: 10px;
      background: #222;
      border: 1px solid #555;
      color: #fff;
      font-size: 13px;
    }

    /* ===== ç›¸æ‰‹å´ã¯å°‘ã—è‰²ã‚’å¤‰ãˆã‚‹ ===== */
    #enemy-status-simple {
      background: #1a1a1a;
      border-color: #666;
    }
    



  </style>
</head>

<body>
<h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆå®Œå…¨ç‰ˆï¼‰</h2>

<!-- ================= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å…¥åŠ› ================= -->
<input id="name" placeholder="åå‰">
<select id="job">
  <option value="1">æˆ¦å£«</option>
  <option value="2">é¨å£«</option>
  <option value="3">åƒ§ä¾¶</option>
  <option value="4">ç›—è³Š</option>
  <option value="5">é­”å°å£«</option>
  <option value="6">é™°é™½å¸«</option>
  <option value="7">éŒ¬é‡‘è¡“å¸«</option>
  <option value="8">å¼“å…µ</option>
</select>
<button onclick="join()">æ¥ç¶š</button>


<!-- ===== ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè‡ªåˆ† / ç›¸æ‰‹ï¼‰ ===== -->
<div class="status-area">
  <div id="my-status-simple" class="status-simple"></div>
  <div id="enemy-status-simple" class="status-simple"></div>
</div>

<h3>è¡Œå‹•</h3>
<button id="atkBtn" disabled onclick="attack()">æ”»æ’ƒ</button>
<button id="skillBtn" disabled onclick="openSkillUI()">ã‚¹ã‚­ãƒ«</button>
<button id="lvupBtn" disabled onclick="tryLevelUp()">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</button>
<button id="itemBtn" disabled onclick="openItemUI()">ã‚¢ã‚¤ãƒ†ãƒ </button>
<button id="shopBtn" disabled onclick="openShop()">ã‚·ãƒ§ãƒƒãƒ—</button>



<h3>ãƒ­ã‚°</h3>
<div class="log-container">
  <div class="log-box" id="battleBox"><div class="log-title">âš” æˆ¦é—˜ãƒ­ã‚°</div></div>
  <div class="log-box" id="systemBox"><div class="log-title">â–¶ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div></div>
  <div class="log-box" id="debugBox"><div class="log-title">ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</div></div>
</div>

<!-- ================= ã‚¹ã‚­ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="skillPopup">
  <div id="skillBox">
    <h3>ã‚¹ã‚­ãƒ«ä¸€è¦§</h3>
    <div id="skillList"></div>
    <button onclick="closeSkillUI()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â–¼ ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
<div id="itemCategoryPopup"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">
  <div style="background:#2b2b2b; padding:20px; border-radius:10px; width:260px;">
    <h3>ã‚«ãƒ†ã‚´ãƒªé¸æŠ</h3>
    <button onclick="openItemCategory('item')">ã‚¢ã‚¤ãƒ†ãƒ </button><br><br>
    <button onclick="openItemCategory('equip')">è£…å‚™</button><br><br>
    <button onclick="openItemCategory('special')">ç‰¹æ®Šè£…å‚™</button><br><br>
    <button onclick="closeItemCategory()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ================= ã‚¢ã‚¤ãƒ†ãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="itemPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">
  <div id="itemBox" style="background:#2b2b2b; padding:20px; border-radius:10px; width:380px;">
    <h3 id="itemPopupTitle">ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</h3>
    <div id="itemList"></div>
    <button onclick="closeItemUI()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â˜… è¿½åŠ ï¼šã‚·ãƒ§ãƒƒãƒ—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="shopPopup" class="popup" style="display:none;">
  <div class="popup-inner">
      <h3>ã‚·ãƒ§ãƒƒãƒ—</h3>

      <div id="shopList"></div>

      <!-- â˜… ã“ã“ã«ç§»å‹•ã•ã›ã‚‹ï¼ˆpopup ã¨é€£å‹•ã—ã¦æ¶ˆãˆã‚‹ï¼‰ -->
      <button onclick="rerollShop()">ã‚·ãƒ§ãƒƒãƒ—æ›´æ–°(10ã‚³ã‚¤ãƒ³)</button>
      <button onclick="closeShopUI()">é–‰ã˜ã‚‹</button>

  </div>
</div>

<!-- ================= ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="statusDetailPopup"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">

  <div style="background:#2b2b2b; padding:20px; border-radius:10px; width:420px;">
    <h3 id="statusDetailTitle">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°</h3>

    <div id="statusDetailBody" style="font-size:13px; line-height:1.6;"></div>

    <div style="text-align:right; margin-top:10px;">
      <button onclick="closeStatusDetail()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>


<script>
let ws;
let myTurn = false;
let myJob = null;
let myLevel = 1;

// ==================== ç’°å¢ƒè‡ªå‹•åˆ¤å®š ====================
// ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆfile://, localhostï¼‰ã‹ã©ã†ã‹
const IS_LOCAL =
  location.protocol === "file:" ||
  location.hostname === "localhost";

// WebSocket æ¥ç¶šå…ˆã‚’è‡ªå‹•åˆ‡æ›¿
const WS_URL = IS_LOCAL
  ? "ws://localhost:8080"
  : "wss://cardbattle-server.onrender.com";

console.log("ENV:", IS_LOCAL ? "LOCAL" : "PRODUCTION");
console.log("WS_URL:", WS_URL);


/* ================= ã‚¹ã‚­ãƒ«å®šç¾©ï¼ˆã‚ãªãŸã®ä»•æ§˜ãã®ã¾ã¾ï¼‰ ================= */
const SKILLS = {
  1:[ {name:"ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒ©ãƒƒã‚·ãƒ¥",desc:"é˜²å¾¡ç„¡è¦–20ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"},
      {name:"ãƒ–ãƒ¬ã‚¤ãƒ–ãƒãƒ£ãƒ¼ã‚¸",desc:"é˜²å¾¡ç„¡è¦–30ï¼‹æ”»æ’ƒ+3ï¼ˆ3Rï¼‰"},
      {name:"ãƒ©ã‚¹ãƒˆãƒ–ãƒ¬ãƒ¼ãƒ‰",desc:"é˜²å¾¡ç„¡è¦–(10ï¼‹è‡ªèº«ã®æ”»æ’ƒåŠ›åˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ )"} ],
  2:[ {name:"ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯",desc:"20ï¼‹é˜²å¾¡+2ï¼ˆ4Rï¼‰"},
      {name:"ã‚¢ã‚¤ã‚¢ãƒ³ãƒãƒ£ãƒ¼ã‚¸",desc:"15ï¼‹é˜²å¾¡åŠ›ï¼‹é˜²å¾¡+4ï¼ˆ3Rï¼‰"},
      {name:"ã‚¸ãƒ£ã‚¹ãƒ†ã‚£ã‚¹ãƒ–ãƒ¬ãƒ¼ãƒ‰",desc:"25ï¼‹è‡ªèº«ã®é˜²å¾¡åŠ›åˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ "} ],
  3:[ {name:"ãƒ’ãƒ¼ãƒ«",desc:"HP27å›å¾©"},
      {name:"ãƒ‡ã‚£ã‚¹ãƒšãƒ«ãƒ’ãƒ¼ãƒ«",desc:"HP32ï¼‹ãƒ‡ãƒãƒ•è§£é™¤"},
      {name:"ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ’ãƒ¼ãƒ«",desc:"HP37ï¼‹ãƒ‡ãƒãƒ•è§£é™¤"} ],
  4:[ {name:"ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼†ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«",desc:"25ï¼‹ç›—ã‚€"},
      {name:"ãƒ€ã‚¬ãƒ¼ãƒ¬ã‚¤ãƒ‰",desc:"25+(ã‚¢ã‚¤ãƒ†ãƒ æ•°Ã—2)+ç›—ã‚€"},
      {name:"ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒ¼ã‚¹ãƒˆ",desc:"å…¨ã‚¢ã‚¤ãƒ†ãƒ ç„¡æ–™ç™ºå‹•"} ],
  5:[ {name:"é­”åŠ›ãƒãƒ£ãƒ¼ã‚¸",desc:"é­”åŠ›+20ï¼ˆ1å›ï¼‰"},
      {name:"ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¹ãƒˆ",desc:"é­”åŠ›30æ¶ˆè²»ãƒ»30DMG"},
      {name:"ãƒ¡ãƒ†ã‚ªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ",desc:"é­”åŠ›å…¨æ¶ˆè²»â†’(æ¶ˆè²»-30)"} ],
  6:[ {name:"å¼ç¥å¬å–šãƒ»åˆç´š",desc:"é¬¼ç«/çŒ«åˆ/ç„æ­¦/çƒå¤©ç‹—"},
      {name:"å¼ç¥å¬å–šãƒ»ä¸Šç´š",desc:"ä¹å°¾/ç™½é¾å«ã‚€ä¸Šç´š1ä½“"},
      {name:"äºŒé‡å¬å–š",desc:"ä¸Šç´šå¼ç¥2ä½“å¬å–š"} ],
  7:[ {name:"éŒ¬æˆ",desc:"è£…å‚™ã‚’2ã¤ç”Ÿæˆ"},
      {name:"ç²¾éŒ¬",desc:"å…¨è£…å‚™â˜…+1"},
      {name:"ä¸‰é‡åˆæˆ",desc:"è£…å‚™3ã¤åˆæˆâ†’ç‰¹æ®Šæ­¦å™¨"} ],
  8:[ {name:"é›†ä¸­å°„æ’ƒ",desc:"3Tè¿½æ’ƒ+1"},
      {name:"ç‹™ã„æ’ƒã¡ï¼‹çŸ¢æ‹¡å¼µ",desc:"çŸ¢ã‚¹ãƒ­+1ï¼†è¿½æ’ƒ+1"},
      {name:"è²«é€šã®çŸ¢",desc:"å…¨çŸ¢ãŒé˜²å¾¡è²«é€šåŒ–"} ],
};

/* ==================== ãƒ­ã‚°è¿½åŠ  ==================== */
function appendLog(boxId, className, text){
  const box=document.getElementById(boxId);
  const div=document.createElement("div");
  div.className="log-line "+className;
  div.textContent=text;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

/* ==================== æ¥ç¶š ==================== */
function join() {
  myJob = Number(document.getElementById("job").value);

  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    appendLog("systemBox", "system-log", "ğŸŒ æ¥ç¶šã—ã¾ã—ãŸã€‚å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…æ©Ÿä¸­â€¦");
    ws.send(JSON.stringify({
      type: "join",
      name: document.getElementById("name").value,
      job: myJob
    }));
  };

  ws.onerror = (e) => {
    appendLog("systemBox", "system-log", "âŒ ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
    console.error("WebSocket error:", e);
  };



  /* ============================================
     WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
     ï¼ˆã“ã“ã ã‘ã§å…¨å‡¦ç†ã™ã‚‹ã‚ˆã†çµ±ä¸€ï¼‰
     ============================================ */
  ws.onmessage = (msg)=>{
    const data = JSON.parse(msg.data);

    if (data.type === "status_simple") {

      const box =
        data.side === "self"
          ? document.getElementById("my-status-simple")
          : document.getElementById("enemy-status-simple");

      let html = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>${data.side === "self" ? "ã‚ãªãŸ" : "ç›¸æ‰‹"}</strong>
          <button onclick="openStatusDetail('${data.side}')">è©³ç´°</button>
        </div>

        <div>HP: ${data.hp} / ${data.max_hp}</div>
        <div>æ”»æ’ƒ: ${data.attack}</div>
        <div>é˜²å¾¡: ${data.defense}</div>
        <div>ã‚³ã‚¤ãƒ³: ${data.coins}</div>
        <div>Lv: ${data.level}</div>
      `;

      if (data.mana !== null) {
        html += `<div>é­”åŠ›: ${data.mana} / ${data.mana_max}</div>`;
      }

      box.innerHTML = html;
      return;
    }


    if (data.type === "status_detail") {

      document.getElementById("statusDetailTitle").textContent =
        data.side === "self" ? "ã‚ãªãŸã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" : "ç›¸æ‰‹ã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹";

      let html = `
        <div><b>HP</b>: ${data.hp} / ${data.max_hp}</div>
        <div><b>æ”»æ’ƒåŠ›</b>: ${data.attack}</div>
        <div><b>é˜²å¾¡åŠ›</b>: ${data.defense}</div>
        <div><b>ã‚³ã‚¤ãƒ³</b>: ${data.coins}</div>
        <div><b>Lv</b>: ${data.level}</div>
        <div><b>EXP</b>: ${data.exp}</div>
      `;

      if (data.mana !== null) {
        html += `<div><b>é­”åŠ›</b>: ${data.mana} / ${data.mana_max}</div>`;
      }

      if (data.equipment?.length) {
        html += `<hr><b>è£…å‚™ä¸­</b><br>${data.equipment.join("<br>")}`;
      }

      if (data.buffs?.length) {
        html += `<hr><b>ãƒãƒ•</b><br>${data.buffs.join("<br>")}`;
      }

      if (data.shikigami?.length) {
        html += `<hr><b>å¼ç¥</b><br>${data.shikigami.join("<br>")}`;
      }

      document.getElementById("statusDetailBody").innerHTML = html;
      document.getElementById("statusDetailPopup").style.display = "flex";
      return;
    }

        /* --- HP --- */
    if(data.type==="hp"){
      document.getElementById("hp").textContent =
        `ã‚ãªãŸã®HP ${data.myHP} / æ•µHP ${data.enemyHP}`;
      return;
    }
    
    if (data.type === "job_info") {
        window.myJob = data.job;
        console.log("My Job = ", window.myJob);
        return;
    }

    if (data.type === "mana_info") {
        const now = data.mana;
        const max = data.mana_max;

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¬„ã«é­”åŠ›ã‚’è¡¨ç¤º
        document.getElementById("mana_now").textContent = now;
        document.getElementById("mana_max").textContent = max;

        // é­”å°å£«ä»¥å¤–ã®å ´åˆã¯ç©ºæ¬„ã«ã™ã‚‹ä»•æ§˜ã«ã™ã‚‹ãªã‚‰ã“ã®ä¸€è¡Œ
        document.getElementById("mana_block").style.display = "block";
    }

    /* --- EXP --- */
    if(data.type==="exp_info"){
      document.getElementById("exp").textContent = data.exp;
      return;
    }

    /* --- ãƒ¬ãƒ™ãƒ«æƒ…å ± --- */
    if(data.type==="level_info"){
      myLevel = data.level;
      document.getElementById("level").textContent = "Lv "+data.level;

      // è‡ªåˆ†ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãªã‚‰æŠ¼ã›ã‚‹
      // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã¯ã€è‡ªåˆ†ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãªã‚‰å¸¸ã«æŠ¼ã›ã‚‹
      document.getElementById("lvupBtn").disabled = !myTurn;


      return;
    }


    if (data.type === "item_list") {
      window.itemList = data.items;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿å­˜
      renderItemList(data.items);
      return;
    }
    
    if (data.type === "status_info") {

        window.arrowSlots = data.arrow_slots ?? 1;

        // â˜… è‡ªåˆ†ã®è·æ¥­ã‚’å‚ç…§ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆå›å—ä¿¡æ™‚ã« window.myJob ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å‰æï¼‰
        const isOnmyoji = (window.myJob === "é™°é™½å¸«");

        // â˜… å¼ç¥è¡¨ç¤ºï¼ˆé™°é™½å¸«ã ã‘ï¼‰
        let shikiHTML = "";
        if (isOnmyoji) {
            shikiHTML = `
                <div id="shikigami-list" style="margin-top:8px; font-size:12px; color:#6cf;">
                    ${
                        !data.shikigami || data.shikigami.length === 0
                        ? "ï¼ˆå¼ç¥ãªã—ï¼‰"
                        : data.shikigami.map(s => `${s}`).join("<br>")
                    }
                </div>
            `;
        }

        document.getElementById("status-panel").innerHTML = `
            æ”»æ’ƒåŠ›ï¼š${data.attack}<br>
            é˜²å¾¡åŠ›ï¼š${data.defense}<br>

            <div id="buff-list" style="margin-top:8px; font-size:12px; color:#ccc;">
                ${
                    data.buffs.length === 0
                    ? "ï¼ˆãƒãƒ•ãªã—ï¼‰"
                    : data.buffs.map(b => `${b}`).join("<br>")
                }
            </div>

            ${shikiHTML}  <!-- â˜… é™°é™½å¸«ã®ã¨ãã ã‘è¡¨ç¤ºã•ã‚Œã‚‹ -->
        `;
        return;
    }



    // â˜…è¿½åŠ ï¼šã‚·ãƒ§ãƒƒãƒ—å•†å“ãƒªã‚¹ãƒˆå—ä¿¡
    if (data.type === "shop_list") {
        renderShop(data.items);
        return;
    }


    /* --- ã‚³ã‚¤ãƒ³ --- */
    if(data.type==="coin_info"){
      document.getElementById("coins").textContent = data.coins;
      return;
    }

    /* --- è‡ªåˆ†ã®ãƒ©ã‚¦ãƒ³ãƒ‰ --- */
    if(data.type==="your_turn"){
      myTurn = true;
      appendLog("systemBox","system-log", data.msg);

      document.getElementById("atkBtn").disabled = false;
      document.getElementById("skillBtn").disabled = false;
      document.getElementById("lvupBtn").disabled = false; // å¸¸ã«æŠ¼ã›ã‚‹
      document.getElementById("itemBtn").disabled = false;
      document.getElementById("shopBtn").disabled = false;

      return;
    }

    /* --- ç›¸æ‰‹ãƒ©ã‚¦ãƒ³ãƒ‰ --- */
    if(data.type==="wait_turn"){
      myTurn = false;
      appendLog("systemBox","system-log", data.msg);

// â˜… ç›¸æ‰‹ãƒ©ã‚¦ãƒ³ãƒ‰ã«ãªã£ãŸã‚‰ã‚·ãƒ§ãƒƒãƒ—ã‚’å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
      closeShopUI();

      document.getElementById("atkBtn").disabled = true;
      document.getElementById("skillBtn").disabled = true;
      document.getElementById("lvupBtn").disabled = true;
      document.getElementById("itemBtn").disabled = true;
      document.getElementById("shopBtn").disabled = true;


      return;
    }

    /* --- æˆ¦é—˜ãƒ­ã‚° --- */
    if(data.type==="battle_log"){
      appendLog("battleBox","battle-log",data.msg);
      return;
    }
    if(data.type==="skill_log"){
      appendLog("battleBox","skill-log",data.msg);
      return;
    }

    /* --- ã‚·ã‚¹ãƒ†ãƒ  --- */
    if(data.type==="system_log"){
      appendLog("systemBox","system-log",data.msg);
      return;
    }

    /* --- ã‚¨ãƒ©ãƒ¼ --- */
    if(data.type==="error_log"){
      appendLog("systemBox","error-log",data.msg);
      return;
    }

    /* --- ãƒ‡ãƒãƒƒã‚° --- */
    if(data.type==="debug_log"){
      appendLog("debugBox","debug-log",data.msg);
      return;
    }

    /* --- level_up_request ã®è¿”ä¿¡ --- */
    if(data.type==="level_up_check"){
      if(data.canExp){
        ws.send(JSON.stringify({type:"level_up_exp"}));
        return;
      }
      if(data.canCoins){
        if(confirm(`EXPä¸è¶³ï¼\nã‚³ã‚¤ãƒ³${data.needCoins}ã§è£œå¡«ã—ã¾ã™ã‹ï¼Ÿ`)){
          ws.send(JSON.stringify({type:"level_up_coins"}));
        }
        return;
      }
      alert("âŒ EXPã‚‚ã‚³ã‚¤ãƒ³ã‚‚è¶³ã‚Šã¾ã›ã‚“ï¼");
    }

  };
}

function rerollShop() {
    ws.send(JSON.stringify({ type: "shop_reroll" }));
}

/* ================= è¡Œå‹• ================= */
function attack(){
  if(!myTurn) return;
  ws.send(JSON.stringify({type:"action", action:"æ”»æ’ƒ"}));
}

/* ================= ã‚¹ã‚­ãƒ«ç³» ================= */
function openSkillUI(){
  const list=document.getElementById("skillList");
  list.innerHTML="";

  SKILLS[myJob].forEach((s,i)=>{
    const needLv=i+1;

    const row=document.createElement("div");
    row.className="skillRow";

    row.innerHTML =
      `<div class="skillName">ã€${i+1}ã€‘${s.name}</div>
       <div class="skillDesc">${s.desc}</div>
       <button onclick="useSkill(${i+1})" ${myLevel<needLv?"disabled":""}>
         ä½¿ç”¨
       </button>`;

    list.appendChild(row);
  });

  document.getElementById("skillPopup").style.display="flex";
}

function closeSkillUI(){
  document.getElementById("skillPopup").style.display="none";
}

function useSkill(num){
  if(!myTurn) return;
  ws.send(JSON.stringify({type:"action", action:"ã‚¹ã‚­ãƒ«"+num}));
  closeSkillUI();
}

/* ================= ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— ================= */
function tryLevelUp(){
  ws.send(JSON.stringify({ type:"level_up_request" }));
}

function openItemUI(){
  document.getElementById("itemCategoryPopup").style.display = "flex";
}


function useItem(id, action, slot = 1){
  ws.send(JSON.stringify({
    type: "use_item",
    item_id: id,
    action: action,
    slot: slot
  }));
  closeItemUI();
}



function openItemUI(){
  document.getElementById("itemCategoryPopup").style.display = "flex";
}

function closeItemCategory(){
  document.getElementById("itemCategoryPopup").style.display = "none";
}

function openItemCategory(category){
  const all = window.itemList || [];
  const list = all.filter(it => it.category === category);

  const titleMap = {
    item: "ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§",
    equip: "è£…å‚™ä¸€è¦§",
    special: "ç‰¹æ®Šè£…å‚™ä¸€è¦§" // â˜…çŸ¢ã‚‚ã“ã“ã«å«ã‚ã‚‹
  };
  document.getElementById("itemPopupTitle").innerText = titleMap[category];

  const box = document.getElementById("itemList");
  box.innerHTML = "";

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "skillRow";

    let btn = "";
    if (category === "item") {
      btn = `<button onclick="useItem('${it.uid}','use')">ä½¿ç”¨</button>`;
    } else if (category === "equip" || category === "special") {
      btn = `<button onclick="onEquipButtonByUid('${it.uid}')">è£…å‚™</button>`;
    }


    row.innerHTML = `
      <div class="skillName">${it.name}</div>
      <div style="font-size:12px; color:#ccc; white-space:pre-line;">
          ${it.effect_text ?? ""}
      </div>
      <div style="margin-top:5px;">
          ${btn}
      </div>
    `;

    box.appendChild(row);
  });

  closeItemCategory();
  document.getElementById("itemPopup").style.display = "flex";
}

function closeItemUI(){
  document.getElementById("itemPopup").style.display = "none";
}

// ========================
// â˜… ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½è¿½åŠ 
// ========================

function openShop(){
  if (!myTurn) return;
  ws.send(JSON.stringify({ type: "open_shop" }));
}

function closeShopUI(){
  document.getElementById("shopPopup").style.display = "none";
}

function renderShop(items){
  const box = document.getElementById("shopList");
  box.innerHTML = "";

  items.forEach((it, idx) => {
    if (!it) return;

    const desc = it.effect_text ?? "";

    box.innerHTML += `
      <div class="skillRow">
        <div>
          <div>${it.name}</div>
          <div>ä¾¡æ ¼: ${it.price} / ${desc}</div>
        </div>
        <div><button onclick="buyItem(${idx})">è³¼å…¥</button></div>
      </div>
    `;
  });

  document.getElementById("shopPopup").style.display = "block";
}

function openStatusDetail(target) {
  ws.send(JSON.stringify({
    type: "request_status_detail",
    target  // "self" or "enemy"
  }));
}

function closeStatusDetail() {
  document.getElementById("statusDetailPopup").style.display = "none";
}

function onEquipButton(item) {

  // çŸ¢ã ã‘ç‰¹åˆ¥æ‰±ã„
  if (item.is_arrow || item.equip_type === "arrow") {

    // slot2 ãŒä½¿ãˆã‚‹ãªã‚‰é¸ã°ã›ã‚‹
    if (window.arrowSlots >= 2) {
      const slot = confirm("ã‚¹ãƒ­ãƒƒãƒˆ2ã«è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ\nOK: ã‚¹ãƒ­ãƒƒãƒˆ2 / ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ã‚¹ãƒ­ãƒƒãƒˆ1")
        ? 2
        : 1;

      useItem(item.uid, "arrow", slot);
    } else {
      useItem(item.uid, "arrow", 1);
    }
    return;
  }

  // ä»¥ä¸‹ã¯ä»Šã¾ã§é€šã‚Š
  if (item.equip_type === "mage_equip" ||
      item.equip_type === "alchemist_unique") {
    useItem(item.uid, "special");
  } else {
    useItem(item.uid, "equip");
  }
}

function onEquipButtonByUid(uid) {
  const item = (window.itemList || []).find(it => it.uid === uid);
  if (!item) {
    console.error("item not found:", uid);
    return;
  }
  onEquipButton(item);
}




function buyItem(index){
  if (!myTurn) return;
  ws.send(JSON.stringify({ type:"buy_item", index }));
  closeShopUI();
}

// ================================
// â˜… renderItemListï¼ˆä¸­èº«ã¯ç©ºã§OKï¼‰
// ================================
function renderItemList(items) {
  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸ item_list ã¯
  // window.itemList ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
  // ç”»é¢è¡¨ç¤ºã¯ openItemCategory() ã®ã¨ãã«è¡Œã‚ã‚Œã‚‹ã€‚
  // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªãã¦ã‚ˆã„ã€‚
}

function toggleEnemyDetail() {
  const el = document.getElementById("enemy-detail");
  el.style.display = (el.style.display === "none") ? "block" : "none";
}
document.getElementById("my-status-simple").innerHTML = `
<b>ã‚ãªãŸ</b><br>
HP: 200<br>
ATK: 30<br>
DEF: 20<br>
COIN: 5<br>
Lv: 1
`;

document.getElementById("enemy-status-simple").innerHTML = `
<b>ç›¸æ‰‹</b><br>
HP: 180<br>
ATK: 25<br>
DEF: 15<br>
COIN: 3<br>
Lv: 1
`;

</script>

</body>
</html>

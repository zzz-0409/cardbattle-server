<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #202020;
      color: #f5f5f5;
    }
    button { padding: 5px 12px; cursor:pointer; }
    button:disabled { background:#666; cursor:default; }

    .log-container { display: flex; gap: 12px; margin-top: 10px;}
    .log-box {
      flex: 1; background:#111; border-radius:6px;
      padding:6px; height:220px; overflow-y: auto;
      font-size: 12px; font-family: Consolas;
    }
    .battle-log{ color:#ffd54f;}
    .skill-log{ color:#81d4fa;}
    .system-log{ color:#a5d6a7;}
    .error-log{ color:#ef9a9a;}
    .debug-log{ color:#b0bec5;}

    #skillPopup{
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.7);
      justify-content:center; align-items:center;
    }
    #skillBox{
      background:#2b2b2b; padding:20px; border-radius:10px;
      width:380px;
    }
    .skillRow{ margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid #555;}
    .skillName{ color:#81d4fa; font-size:16px; }
    .skillDesc{ white-space:pre-line; font-size:13px; color:#ddd; }


   
    /* ===== ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¨ä½“ ===== */
    .status-area {
      margin-top: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 12px;
    }

    /* ===== è‡ªåˆ† / ç›¸æ‰‹ å…±é€š ===== */
    .status-simple {
      width: 240px;
      padding: 10px;
      background: #222;
      border: 1px solid #555;
      color: #fff;
      font-size: 13px;
    }

    /* ===== ç›¸æ‰‹å´ã¯å°‘ã—è‰²ã‚’å¤‰ãˆã‚‹ ===== */
    #enemy-status-simple {
      background: #1a1a1a;
      border-color: #666;
    }
    



  </style>
</head>

<body>
<h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆå®Œå…¨ç‰ˆï¼‰</h2>

<!-- ================= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å…¥åŠ› ================= -->
<input id="name" placeholder="åå‰">
<select id="job">
  <option value="1">æˆ¦å£«</option>
  <option value="2">é¨å£«</option>
  <option value="3">åƒ§ä¾¶</option>
  <option value="4">ç›—è³Š</option>
  <option value="5">é­”å°å£«</option>
  <option value="6">é™°é™½å¸«</option>
  <option value="7">éŒ¬é‡‘è¡“å¸«</option>
  <option value="8">å¼“å…µ</option>
  <option value="9">äººå½¢ä½¿ã„</option>

</select>
<button onclick="join()">æ¥ç¶š</button>


<!-- ===== ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè‡ªåˆ† / ç›¸æ‰‹ï¼‰ ===== -->
<div class="status-area">
  <div id="my-status-simple" class="status-simple"></div>
  <div id="enemy-status-simple" class="status-simple"></div>
</div>

<h3>è¡Œå‹•</h3>
<button id="atkBtn" disabled onclick="attack()">æ”»æ’ƒ</button>
<button id="skillBtn" disabled onclick="openSkillUI()">ã‚¹ã‚­ãƒ«</button>
<button id="lvupBtn" disabled onclick="tryLevelUp()">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</button>
<button id="itemBtn" disabled onclick="openItemUI()">ã‚¢ã‚¤ãƒ†ãƒ </button>
<button id="shopBtn" disabled onclick="openShop()">ã‚·ãƒ§ãƒƒãƒ—</button>



<h3>ãƒ­ã‚°</h3>
<div class="log-container">
  <div class="log-box" id="battleBox"><div class="log-title">âš” æˆ¦é—˜ãƒ­ã‚°</div></div>
  <div class="log-box" id="systemBox"><div class="log-title">â–¶ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div></div>
  <div class="log-box" id="debugBox"><div class="log-title">ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</div></div>
</div>

<!-- ================= ã‚¹ã‚­ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="skillPopup">
  <div id="skillBox">
    <h3>ã‚¹ã‚­ãƒ«ä¸€è¦§</h3>
    <div id="skillList"></div>
    <button onclick="closeSkillUI()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â–¼ ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
<div id="itemCategoryPopup"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">
  <div style="background:#2b2b2b; padding:20px; border-radius:10px; width:260px;">
    <h3>ã‚«ãƒ†ã‚´ãƒªé¸æŠ</h3>
    <button onclick="openItemCategory('item')">ã‚¢ã‚¤ãƒ†ãƒ </button><br><br>
    <button onclick="openItemCategory('equip')">è£…å‚™</button><br><br>
    <button onclick="openItemCategory('special')">ç‰¹æ®Šè£…å‚™</button><br><br>
    <button onclick="closeItemCategory()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ================= ã‚¢ã‚¤ãƒ†ãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="itemPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">
  <div id="itemBox" style="background:#2b2b2b; padding:20px; border-radius:10px; width:380px;">
    <h3 id="itemPopupTitle">ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§</h3>
    <div id="itemList"></div>
    <button onclick="closeItemUI()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- â˜… è¿½åŠ ï¼šã‚·ãƒ§ãƒƒãƒ—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="shopPopup" class="popup" style="display:none;">
  <div class="popup-inner">
      <h3>ã‚·ãƒ§ãƒƒãƒ—</h3>

      <div id="shopList"></div>

      <!-- â˜… ã“ã“ã«ç§»å‹•ã•ã›ã‚‹ï¼ˆpopup ã¨é€£å‹•ã—ã¦æ¶ˆãˆã‚‹ï¼‰ -->
      <button onclick="rerollShop()">ã‚·ãƒ§ãƒƒãƒ—æ›´æ–°(10ã‚³ã‚¤ãƒ³)</button>
      <button onclick="closeShopUI()">é–‰ã˜ã‚‹</button>

  </div>
</div>

<!-- ================= ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ================= -->
<div id="statusDetailPopup"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); justify-content:center; align-items:center;">

  <div style="background:#2b2b2b; padding:20px; border-radius:10px; width:420px;">
    <h3 id="statusDetailTitle">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°</h3>

    <div id="statusDetailBody" style="font-size:13px; line-height:1.6;"></div>

    <div style="text-align:right; margin-top:10px;">
      <button onclick="closeStatusDetail()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>


<script>
/* ====================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
==================== */

let currentItemCategory = null;
let isItemUIOpen = false; // â˜… è¿½åŠ 
let ws;
let myTurn = false;
let myJob = null;
let myLevel = 1;

// ==================== ç’°å¢ƒè‡ªå‹•åˆ¤å®š ====================
// ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆfile://, localhostï¼‰ã‹ã©ã†ã‹
const IS_LOCAL =
  location.protocol === "file:" ||
  location.hostname === "localhost";

// WebSocket æ¥ç¶šå…ˆã‚’è‡ªå‹•åˆ‡æ›¿
const WS_URL = IS_LOCAL
  ? "ws://localhost:8080"
  : "wss://cardbattle-server.onrender.com";

console.log("ENV:", IS_LOCAL ? "LOCAL" : "PRODUCTION");
console.log("WS_URL:", WS_URL);


/* ================= ã‚¹ã‚­ãƒ«å®šç¾©ï¼ˆã‚ãªãŸã®ä»•æ§˜ãã®ã¾ã¾ï¼‰ ================= */
const SKILLS = {
  1:[ {name:"ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒ©ãƒƒã‚·ãƒ¥",desc:"é˜²å¾¡ç„¡è¦–20ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"},
      {name:"ãƒ–ãƒ¬ã‚¤ãƒ–ãƒãƒ£ãƒ¼ã‚¸",desc:"é˜²å¾¡ç„¡è¦–30ï¼‹æ”»æ’ƒ+3ï¼ˆ3Rï¼‰"},
      {name:"ãƒ©ã‚¹ãƒˆãƒ–ãƒ¬ãƒ¼ãƒ‰",desc:"é˜²å¾¡ç„¡è¦–(10ï¼‹è‡ªèº«ã®æ”»æ’ƒåŠ›åˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ )"} ],
  2:[ {name:"ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ–ãƒ¬ã‚¤ã‚¯",desc:"20ï¼‹é˜²å¾¡+2ï¼ˆ4Rï¼‰"},
      {name:"ã‚¢ã‚¤ã‚¢ãƒ³ãƒãƒ£ãƒ¼ã‚¸",desc:"15ï¼‹é˜²å¾¡åŠ›ï¼‹é˜²å¾¡+4ï¼ˆ3Rï¼‰"},
      {name:"ã‚¸ãƒ£ã‚¹ãƒ†ã‚£ã‚¹ãƒ–ãƒ¬ãƒ¼ãƒ‰",desc:"25ï¼‹è‡ªèº«ã®é˜²å¾¡åŠ›åˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—åŠ "} ],
  3:[ {name:"ãƒ’ãƒ¼ãƒ«",desc:"HP27å›å¾©"},
      {name:"ãƒ‡ã‚£ã‚¹ãƒšãƒ«ãƒ’ãƒ¼ãƒ«",desc:"HP32ï¼‹ãƒ‡ãƒãƒ•è§£é™¤"},
      {name:"ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ’ãƒ¼ãƒ«",desc:"HP37ï¼‹ãƒ‡ãƒãƒ•è§£é™¤"} ],
  4:[ {name:"ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼†ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«",desc:"25ï¼‹ç›—ã‚€"},
      {name:"ãƒ€ã‚¬ãƒ¼ãƒ¬ã‚¤ãƒ‰",desc:"25+(ã‚¢ã‚¤ãƒ†ãƒ æ•°Ã—2)+ç›—ã‚€"},
      {name:"ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒ¼ã‚¹ãƒˆ",desc:"å…¨ã‚¢ã‚¤ãƒ†ãƒ ç„¡æ–™ç™ºå‹•"} ],
  5:[ {name:"é­”åŠ›ãƒãƒ£ãƒ¼ã‚¸",desc:"é­”åŠ›+20ï¼ˆ1å›ï¼‰"},
      {name:"ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¹ãƒˆ",desc:"é­”åŠ›30æ¶ˆè²»ãƒ»30DMG"},
      {name:"ãƒ¡ãƒ†ã‚ªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ",desc:"é­”åŠ›å…¨æ¶ˆè²»â†’(æ¶ˆè²»-30)"} ],
  6:[ {name:"å¼ç¥å¬å–šãƒ»åˆç´š",desc:"é¬¼ç«/çŒ«åˆ/ç„æ­¦/çƒå¤©ç‹—"},
      {name:"å¼ç¥å¬å–šãƒ»ä¸Šç´š",desc:"ä¹å°¾/ç™½é¾å«ã‚€ä¸Šç´š1ä½“"},
      {name:"äºŒé‡å¬å–š",desc:"ä¸Šç´šå¼ç¥2ä½“å¬å–š"} ],
  7:[ {name:"éŒ¬æˆ",desc:"è£…å‚™ã‚’2ã¤ç”Ÿæˆ"},
      {name:"ç²¾éŒ¬",desc:"å…¨è£…å‚™â˜…+1"},
      {name:"ä¸‰é‡åˆæˆ",desc:"è£…å‚™3ã¤åˆæˆâ†’ç‰¹æ®Šæ­¦å™¨"} ],
  8:[ {name:"é›†ä¸­å°„æ’ƒ",desc:"3Tè¿½æ’ƒ+1"},
      {name:"ç‹™ã„æ’ƒã¡ï¼‹çŸ¢æ‹¡å¼µ",desc:"çŸ¢ã‚¹ãƒ­+1ï¼†è¿½æ’ƒ+1"},
      {name:"è²«é€šã®çŸ¢",desc:"å…¨çŸ¢ãŒé˜²å¾¡è²«é€šåŒ–"} ],
  9:[
    {
      name:"ä»•ç«‹ã¦ç›´ã—",
      desc:"äººå½¢ã®è¡£è£…ã‚’1ã¤ã‚’é¸ã³ã€â˜…ã‚’+1ã™ã‚‹ï¼ˆæœ€å¤§â˜…4ï¼‰"
    },
    {
      name:"ç”Ÿå‘½ç¸«åˆ",
      desc:"è‡ªèº«ã®HPã‚’æ¶ˆè²»ã—ã€äººå½¢ã®è€ä¹…åŠ›ã‚’å›å¾©ã™ã‚‹ï¼ˆHP0ä¸å¯ï¼‰"
    },
    {
      name:"äººå½¢æš´èµ°",
      desc:"äººå½¢ã‚’æš´èµ°çŠ¶æ…‹ã«ã—ã€ç ´å£Šã•ã‚Œã‚‹ã¾ã§ãƒ‘ãƒ¼ãƒ„åŠ¹æœãŒ2å€ã«ãªã‚‹"
    },
  ],

};



/* ==================== ãƒ­ã‚°è¿½åŠ  ==================== */
function appendLog(boxId, className, text){
  const box=document.getElementById(boxId);
  const div=document.createElement("div");
  div.className="log-line "+className;
  div.textContent=text;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

/* ==================== æ¥ç¶š ==================== */
function join() {
  myJob = Number(document.getElementById("job").value);

  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    appendLog("systemBox", "system-log", "ğŸŒ æ¥ç¶šã—ã¾ã—ãŸã€‚å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…æ©Ÿä¸­â€¦");
    ws.send(JSON.stringify({
      type: "join",
      name: document.getElementById("name").value,
      job: myJob
    }));
  };

  ws.onerror = (e) => {
    appendLog("systemBox", "system-log", "âŒ ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
    console.error("WebSocket error:", e);
  };



  /* ============================================
     WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
     ï¼ˆã“ã“ã ã‘ã§å…¨å‡¦ç†ã™ã‚‹ã‚ˆã†çµ±ä¸€ï¼‰
     ============================================ */
  ws.onmessage = (msg)=>{
    const data = JSON.parse(msg.data);

    // äººå½¢ä½¿ã„ï¼šç€ã›æ›¿ãˆéƒ¨ä½é¸æŠï¼ˆç°¡æ˜“UIï¼‰
    if (data.type === "request_doll_part_select") {

      const parts = [
        { key: "head", label: "å¸½å­" },
        { key: "body", label: "æœ" },
        { key: "leg",  label: "ã‚ºãƒœãƒ³" },
        { key: "foot", label: "é´" }
      ];

      const popup = document.getElementById("skillPopup");
      const list  = document.getElementById("skillList");

      let html = `<div style="font-weight:bold; margin-bottom:8px;">
        å¼·åŒ–ã™ã‚‹éƒ¨ä½ã‚’é¸ã‚“ã§ãã ã•ã„
      </div>`;

      for (const p of parts) {
        html += `
          <button onclick="selectDollPart('${p.key}')" style="margin:4px;">
            ${p.label}
          </button><br>
        `;
      }

      list.innerHTML = html;
      popup.style.display = "flex";
      return;
    }


    if (data.type === "status_simple") {

      const box =
        data.side === "self"
          ? document.getElementById("my-status-simple")
          : document.getElementById("enemy-status-simple");

      let html = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>${data.side === "self" ? "ã‚ãªãŸ" : "ç›¸æ‰‹"}</strong>
          <button onclick="openStatusDetail('${data.side}')">è©³ç´°</button>
        </div>

        <div style="display:flex; gap:8px; margin-top:6px;">
          
          <!-- å·¦ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
          <div style="flex:1;">
            <div>HP: ${data.hp} / ${data.max_hp}</div>
            <div>æ”»æ’ƒ: ${data.attack}</div>
            <div>é˜²å¾¡: ${data.defense}</div>
            <div>ã‚³ã‚¤ãƒ³: ${data.coins}</div>
            <div>Lv: ${data.level}</div>
            ${
              data.mana !== null
                ? `<div>é­”åŠ›: ${data.mana} / ${data.mana_max}</div>`
                : ""
            }
          </div>

          <!-- å³ï¼šäººå½¢ -->
          <div style="flex:1; border-left:1px solid #555; padding-left:6px;">
            ${
              data.doll
                ? `
                  <div style="color:#f6c;">ğŸª† äººå½¢</div>
                  <div>è€ä¹…: ${data.doll.durability} / ${data.doll.max_durability}
                    ${data.doll.is_broken ? "ï¼ˆç ´å£Šï¼‰" : ""}
                  </div>
                  <div>æ”»æ’ƒ: ${data.doll.attack}</div>
                  <div>é˜²å¾¡: ${data.doll.defense}</div>
                `
                : `<div style="color:#777;">äººå½¢ãªã—</div>`
            }
          </div>

        </div>
      `;


      box.innerHTML = html;
      return;
    }


    if (data.type === "status_detail") {
      console.log("status_detail data:", data);

      document.getElementById("statusDetailTitle").textContent =
        data.side === "self" ? "ã‚ãªãŸã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" : "ç›¸æ‰‹ã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹";

      let html = `
        <div><b>HP</b>: ${data.hp} / ${data.max_hp}</div>
        <div><b>æ”»æ’ƒåŠ›</b>: ${data.attack}</div>
        <div><b>é˜²å¾¡åŠ›</b>: ${data.defense}</div>
        <div><b>ã‚³ã‚¤ãƒ³</b>: ${data.coins}</div>
        <div><b>Lv</b>: ${data.level}</div>
        <div><b>EXP</b>: ${data.exp}</div>
      `;

      if (data.mana !== null) {
        html += `<div><b>é­”åŠ›</b>: ${data.mana} / ${data.mana_max}</div>`;
      }

      if (data.equipment?.length) {
        html += `<hr><b>è£…å‚™ä¸­</b><br>${data.equipment.join("<br>")}`;
      }

      if (data.buffs?.length) {
        html += `<hr><b>ãƒãƒ•</b><br>${data.buffs.join("<br>")}`;
      }

      if (data.shikigami?.length) {
        html += `<hr><b>å¼ç¥</b><br>${data.shikigami.join("<br>")}`;
      }
      // ================================
      // â˜… äººå½¢ä½¿ã„ï¼šè£…å‚™ä¸­ã®è¡£è£…è¡¨ç¤º
      // ================================
      if (data.doll && data.doll.costumes) {

        html += `<hr><b>ğŸª† äººå½¢</b><br>`;
        html += `è€ä¹…ï¼š${data.doll.durability} / ${data.doll.max_durability}`;
        if (data.doll.is_broken) {
          html += `ï¼ˆç ´å£Šï¼‰`;
        }
        html += `<br>`;
        html += `æ”»æ’ƒï¼š${data.doll.attack}<br>`;
        html += `é˜²å¾¡ï¼š${data.doll.defense}<br><br>`;

        html += `<b>äººå½¢ã®è¡£è£…</b><br>`;

        const parts = {
          head: "é ­",
          body: "èƒ´",
          leg: "è„š",
          foot: "è¶³"
        };

        for (const [part, label] of Object.entries(parts)) {
          const c = data.doll.costumes[part];
          if (c) {
            html += `${label}ï¼šâ˜…${c.star ?? 1} ${c.name ?? "è¡£è£…"}<br>`;
          } else {
            html += `${label}ï¼šãªã—<br>`;
          }
        }
      }


      document.getElementById("statusDetailBody").innerHTML = html;
      document.getElementById("statusDetailPopup").style.display = "flex";
      return;
    }

    /* --- HP --- */
    if (data.type === "hp") {
      const hpEl = document.getElementById("hp");
      if (hpEl) {
        hpEl.textContent =
          `ã‚ãªãŸã®HP ${data.myHP} / æ•µHP ${data.enemyHP}`;
      }
      return;
}


    
    if (data.type === "job_info") {
        window.myJob = data.job;
        console.log("My Job = ", window.myJob);
        return;
    }

    if (data.type === "mana_info") {
      const nowEl = document.getElementById("mana_now");
      const maxEl = document.getElementById("mana_max");
      const blockEl = document.getElementById("mana_block");

      if (nowEl && maxEl) {
        nowEl.textContent = data.mana;
        maxEl.textContent = data.mana_max;
      }

      if (blockEl) {
        blockEl.style.display = "block";
      }
      return;
    }

    /* --- EXP --- */
    if (data.type === "exp_info") {
      const expEl = document.getElementById("exp");
      if (expEl) {
        expEl.textContent = data.exp;
      }
      return;
    }


    /* --- ãƒ¬ãƒ™ãƒ«æƒ…å ± --- */
    if (data.type === "level_info") {
      myLevel = data.level;

      const levelEl = document.getElementById("level");
      if (levelEl) {
        levelEl.textContent = "Lv " + data.level;
      }

      const lvupBtn = document.getElementById("lvupBtn");
      if (lvupBtn) {
        lvupBtn.disabled = !myTurn;
      }

      return;
    }



    if (data.type === "item_list") {
      window.itemList = data.items;

      // â˜…ã€Œé–‹ã„ã¦ã„ã‚‹ã¨ãã ã‘ã€å†æç”»
      if (isItemUIOpen && currentItemCategory !== null) {
        openItemCategory(currentItemCategory);
      }
      return;
    }


    
    if (data.type === "status_info") {

      window.arrowSlots = data.arrow_slots ?? 1;
      const isOnmyoji = (window.myJob === "é™°é™½å¸«");

      // ---------------------------
      // å¼ç¥è¡¨ç¤ºï¼ˆé™°é™½å¸«ï¼‰
      // ---------------------------
      let shikiHTML = "";
      if (isOnmyoji) {
        shikiHTML = `
          <div id="shikigami-list" style="margin-top:8px; font-size:12px; color:#6cf;">
            ${
              !data.shikigami || data.shikigami.length === 0
                ? "ï¼ˆå¼ç¥ãªã—ï¼‰"
                : data.shikigami.map(s => `${s}`).join("<br>")
            }
          </div>
        `;
      }

      // ---------------------------
      // äººå½¢è¡¨ç¤ºï¼ˆäººå½¢ä½¿ã„ï¼‰
      // ---------------------------
      let dollHTML = "";
      if (data.doll) {
        const state = data.doll.is_broken ? "ï¼ˆç ´å£Šï¼‰" : "";
        dollHTML = `
          <hr>
          <div style="margin-top:6px; color:#f6c;">
            ğŸª† äººå½¢è€ä¹…ï¼š${data.doll.durability} / ${data.doll.max_durability} ${state}
          </div>
        `;
      }

      const panel = document.getElementById("status-panel");
      if (!panel) return;

      panel.innerHTML = `
        æ”»æ’ƒåŠ›ï¼š${data.attack}<br>
        é˜²å¾¡åŠ›ï¼š${data.defense}<br>

        <div id="buff-list" style="margin-top:8px; font-size:12px; color:#ccc;">
          ${
            data.buffs.length === 0
              ? "ï¼ˆãƒãƒ•ãªã—ï¼‰"
              : data.buffs.map(b => `${b}`).join("<br>")
          }
        </div>

        ${shikiHTML}
        ${dollHTML}
      `;

      return;
    }





    // â˜…è¿½åŠ ï¼šã‚·ãƒ§ãƒƒãƒ—å•†å“ãƒªã‚¹ãƒˆå—ä¿¡
    if (data.type === "shop_list") {
        renderShop(data.items);
        return;
    }


    /* --- ã‚³ã‚¤ãƒ³ --- */
    if (data.type === "coin_info") {
      const coinEl = document.getElementById("coins");
      if (coinEl) {
        coinEl.textContent = data.coins;
      }
      return;
    }

    /* --- è‡ªåˆ†ã®ãƒ©ã‚¦ãƒ³ãƒ‰ --- */
    if(data.type==="your_turn"){
      myTurn = true;
      appendLog("systemBox","system-log", data.msg);

      document.getElementById("atkBtn").disabled = false;
      document.getElementById("skillBtn").disabled = false;
      document.getElementById("lvupBtn").disabled = false; // å¸¸ã«æŠ¼ã›ã‚‹
      document.getElementById("itemBtn").disabled = false;
      document.getElementById("shopBtn").disabled = false;

      return;
    }

    /* --- ç›¸æ‰‹ãƒ©ã‚¦ãƒ³ãƒ‰ --- */
    if(data.type==="wait_turn"){
      myTurn = false;
      appendLog("systemBox","system-log", data.msg);

// â˜… ç›¸æ‰‹ãƒ©ã‚¦ãƒ³ãƒ‰ã«ãªã£ãŸã‚‰ã‚·ãƒ§ãƒƒãƒ—ã‚’å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
      closeShopUI();

      document.getElementById("atkBtn").disabled = true;
      document.getElementById("skillBtn").disabled = true;
      document.getElementById("lvupBtn").disabled = true;
      document.getElementById("itemBtn").disabled = true;
      document.getElementById("shopBtn").disabled = true;


      return;
    }

    /* --- æˆ¦é—˜ãƒ­ã‚° --- */
    if(data.type==="battle_log"){
      appendLog("battleBox","battle-log",data.msg);
      return;
    }
    if(data.type==="skill_log"){
      appendLog("battleBox","skill-log",data.msg);
      return;
    }

    /* --- ã‚·ã‚¹ãƒ†ãƒ  --- */
    if(data.type==="system_log"){
      appendLog("systemBox","system-log",data.msg);
      return;
    }

    /* --- ã‚¨ãƒ©ãƒ¼ --- */
    if(data.type==="error_log"){
      appendLog("systemBox","error-log",data.msg);
      return;
    }

    /* --- ãƒ‡ãƒãƒƒã‚° --- */
    if(data.type==="debug_log"){
      appendLog("debugBox","debug-log",data.msg);
      return;
    }

    /* --- level_up_request ã®è¿”ä¿¡ --- */
    if(data.type==="level_up_check"){
      if(data.canExp){
        ws.send(JSON.stringify({type:"level_up_exp"}));
        return;
      }
      if(data.canCoins){
        if(confirm(`EXPä¸è¶³ï¼\nã‚³ã‚¤ãƒ³${data.needCoins}ã§è£œå¡«ã—ã¾ã™ã‹ï¼Ÿ`)){
          ws.send(JSON.stringify({type:"level_up_coins"}));
        }
        return;
      }
      alert("âŒ EXPã‚‚ã‚³ã‚¤ãƒ³ã‚‚è¶³ã‚Šã¾ã›ã‚“ï¼");
    }

    // ---------- ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨çµæœ ----------
    if (data.type === "use_item_result") {
        if (data.success) {
            // æ­£å¸¸ä½¿ç”¨ â†’ ã‚¢ã‚¤ãƒ†ãƒ UIã‚’é–‰ã˜ã¦è¡Œå‹•ã«æˆ»ã‚‹
            closeItemUI();
        } else {
            // å¤±æ•— â†’ ã‚«ãƒ†ã‚´ãƒªé¸æŠã«æˆ»ã™
            document.getElementById("itemCategoryPopup").style.display = "flex";
            if (data.message) {
                alert(data.message);
            }
        }
        return;
    }

  };
}

function rerollShop() {
    ws.send(JSON.stringify({ type: "shop_reroll" }));
}

/* ================= è¡Œå‹• ================= */
function attack(){
  if(!myTurn) return;
  ws.send(JSON.stringify({type:"action", action:"æ”»æ’ƒ"}));
}

/* ================= ã‚¹ã‚­ãƒ«ç³» ================= */
function openSkillUI(){
  const list=document.getElementById("skillList");
  list.innerHTML="";

  SKILLS[myJob].forEach((s,i)=>{
    const needLv=i+1;

    const row=document.createElement("div");
    row.className="skillRow";

    const isDoll = (Number(myJob) === 9 || myJob === "äººå½¢ä½¿ã„");
    const isDollSkill1 = isDoll && i === 0;
    const isDollSkill2 = isDoll && i === 1;
    const isDollSkill3 = isDoll && i === 2;


    row.innerHTML =
      `<div class="skillName">ã€${i+1}ã€‘${s.name}</div>
      <div class="skillDesc">${s.desc}</div>
      <button
        onclick="${
          isDollSkill1 ? "useDollSkill1()"
          : isDollSkill2 ? "useDollSkill2Prompt()"
          : isDollSkill3 ? "useDollSkill3()"
          : `useSkill(${i+1})`
        }"

        ${myLevel<needLv?"disabled":""}>
        ä½¿ç”¨
      </button>`;


    list.appendChild(row);
  });

  document.getElementById("skillPopup").style.display="flex";
}


function closeSkillUI(){
  document.getElementById("skillPopup").style.display="none";
}

function useSkill(num){
  if(!myTurn) return;
  ws.send(JSON.stringify({type:"action", action:"ã‚¹ã‚­ãƒ«"+num}));
  closeSkillUI();
}
// ================================
// äººå½¢ä½¿ã„ï¼šã‚¹ã‚­ãƒ«1å°‚ç”¨å…¥å£
// ================================
function useDollSkill1(){
  if(!myTurn) return;

  ws.send(JSON.stringify({
    type: "request_doll_skill1"
  }));
  console.log("[client] request_doll_skill1 sent");
  closeSkillUI();
}

// ================================
// äººå½¢ä½¿ã„ï¼šã‚¹ã‚­ãƒ«2ï¼ˆç”Ÿå‘½ç¸«åˆï¼‰HPâ†’è€ä¹…
// ================================
function useDollSkill2Prompt(){
  if(!myTurn) return;

  const s = prompt("æ¶ˆè²»ã™ã‚‹HPã‚’å…¥åŠ›ï¼ˆ10ã®å€æ•° / 10ã€œ100ï¼‰", "10");
  if (s === null) return;

  const hpCost = Number(s);

  ws.send(JSON.stringify({
    type: "use_doll_skill2",
    hpCost
  }));

  console.log("[client] use_doll_skill2 sent:", hpCost);
  closeSkillUI();
}
// ================================
// äººå½¢ä½¿ã„ï¼šã‚¹ã‚­ãƒ«3ï¼ˆæš´èµ°ï¼‰
// ================================
function useDollSkill3(){
  if(!myTurn) return;

  ws.send(JSON.stringify({
    type: "request_doll_skill3"
  }));

  console.log("[client] request_doll_skill3 sent");
  closeSkillUI();
}

/* ================= ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— ================= */
function tryLevelUp(){
  ws.send(JSON.stringify({ type:"level_up_request" }));
}

function openItemUI(){
  document.getElementById("itemCategoryPopup").style.display = "flex";
}


function useItem(id, action, slot = 1){
  console.log("[CLIENT] useItem called", id, action, slot);

  ws.send(JSON.stringify({
    type: "use_item",
    item_id: id,
    action: action,
    slot: slot
  }));

}



function openItemUI(){
  document.getElementById("itemCategoryPopup").style.display = "flex";
}

function closeItemCategory(){
  document.getElementById("itemCategoryPopup").style.display = "none";
}



function openItemCategory(category){
  currentItemCategory = category;
  isItemUIOpen = true; // â˜… é–‹ã„ãŸ

  const all = window.itemList || [];
  const list = all.filter(it => it.category === category);

  const titleMap = {
    item: "ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§",
    equip: "è£…å‚™ä¸€è¦§",
    special: "ç‰¹æ®Šè£…å‚™ä¸€è¦§"
  };
  document.getElementById("itemPopupTitle").innerText = titleMap[category];

  const box = document.getElementById("itemList");
  box.innerHTML = "";

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "skillRow";

    let btn = "";

    // â˜… ä½¿ç”¨ã§ãã‚‹ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆå›å¾©ãƒ»ä¿®ç†ã‚­ãƒƒãƒˆãªã©ï¼‰
    if (
      category === "item" ||
      (category === "special" && it.name === "ä¿®ç†ã‚­ãƒƒãƒˆ")
    ) {
      btn = `<button onclick="useItem('${it.uid}','use')">ä½¿ç”¨</button>`;
    }
    // â˜… è£…å‚™ç³»
    else {
      btn = `<button onclick="onEquipButtonByUid('${it.uid}')">è£…å‚™</button>`;
    }


    row.innerHTML = `
      <div class="skillName">${it.name}</div>
      <div style="font-size:12px; color:#ccc; white-space:pre-line;">
        ${it.effect_text ?? ""}
      </div>
      <div style="margin-top:5px;">${btn}</div>
    `;

    box.appendChild(row);
  });

  document.getElementById("itemPopup").style.display = "flex";
}

function closeItemUI(){
  document.getElementById("itemPopup").style.display = "none";
  isItemUIOpen = false;        // â˜… é–‰ã˜ãŸ
  currentItemCategory = null; // â˜… ãƒªã‚»ãƒƒãƒˆ
}



// ========================
// â˜… ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½è¿½åŠ 
// ========================

function openShop(){
  if (!myTurn) return;
  ws.send(JSON.stringify({ type: "open_shop" }));
}

function closeShopUI(){
  document.getElementById("shopPopup").style.display = "none";
}

function renderShop(items){
  const box = document.getElementById("shopList");
  box.innerHTML = "";

  items.forEach((it, idx) => {
    if (!it) return;

    const desc = it.effect_text ?? "";

    box.innerHTML += `
      <div class="skillRow">
        <div>
          <div>${it.name}</div>
          <div>ä¾¡æ ¼: ${it.price} / ${desc}</div>
        </div>
        <div><button onclick="buyItem(${idx})">è³¼å…¥</button></div>
      </div>
    `;
  });

  document.getElementById("shopPopup").style.display = "block";
}

function openStatusDetail(target) {
  ws.send(JSON.stringify({
    type: "request_status_detail",
    target  // "self" or "enemy"
  }));
}

function closeStatusDetail() {
  document.getElementById("statusDetailPopup").style.display = "none";
}

function onEquipButton(item) {
  // â˜… äººå½¢è¡£è£…ã¯ special æ‰±ã„
  if (item.is_doll_costume) {
    useItem(item.uid, "special");
    return;
  }  

  // çŸ¢ã ã‘ç‰¹åˆ¥æ‰±ã„
  if (item.is_arrow || item.equip_type === "arrow") {

    // slot2 ãŒä½¿ãˆã‚‹ãªã‚‰é¸ã°ã›ã‚‹
    if (window.arrowSlots >= 2) {
      const slot = confirm("ã‚¹ãƒ­ãƒƒãƒˆ2ã«è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ\nOK: ã‚¹ãƒ­ãƒƒãƒˆ2 / ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ã‚¹ãƒ­ãƒƒãƒˆ1")
        ? 2
        : 1;

      useItem(item.uid, "arrow", slot);
    } else {
      useItem(item.uid, "arrow", 1);
    }
    return;
  }

  // ä»¥ä¸‹ã¯ä»Šã¾ã§é€šã‚Š
  if (item.equip_type === "mage_equip" ||
      item.equip_type === "alchemist_unique") {
    useItem(item.uid, "special");
  } else {
    useItem(item.uid, "equip");
  }
}

function onEquipButtonByUid(uid) {
  const item = (window.itemList || []).find(it => it.uid === uid);
  if (!item) {
    console.error("item not found:", uid);
    return;
  }
  onEquipButton(item);
}


function selectDollPart(part){
  console.log("[client] selectDollPart:", part);

  ws.send(JSON.stringify({
    type: "use_doll_skill1",
    part
  }));

  closeSkillUI();   // â˜… æ—¢å­˜ã®é–¢æ•°ã«åˆã‚ã›ã‚‹
}


function buyItem(index){
  if (!myTurn) return;
  ws.send(JSON.stringify({ type:"buy_item", index }));
  closeShopUI();
}

// ================================
// â˜… renderItemListï¼ˆä¸­èº«ã¯ç©ºã§OKï¼‰
// ================================
function renderItemList(items) {
  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸ item_list ã¯
  // window.itemList ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
  // ç”»é¢è¡¨ç¤ºã¯ openItemCategory() ã®ã¨ãã«è¡Œã‚ã‚Œã‚‹ã€‚
  // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªãã¦ã‚ˆã„ã€‚
}

function toggleEnemyDetail() {
  const el = document.getElementById("enemy-detail");
  el.style.display = (el.style.display === "none") ? "block" : "none";
}
document.getElementById("my-status-simple").innerHTML = `
<b>ã‚ãªãŸ</b><br>
HP: 200<br>
ATK: 30<br>
DEF: 20<br>
COIN: 5<br>
Lv: 1
`;

document.getElementById("enemy-status-simple").innerHTML = `
<b>ç›¸æ‰‹</b><br>
HP: 180<br>
ATK: 25<br>
DEF: 15<br>
COIN: 3<br>
Lv: 1
`;

</script>

</body>
</html>
